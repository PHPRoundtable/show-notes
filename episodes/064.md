# Summary
We take a deep-dive into the underlaying structure of the the PHP source code and talk about the scanner, parser, the new AST layer (and the evil things we can do with it), and the Zend engine. Let's see how the PHP sausage is made!

# Guests
* [Sara Golemon](https://twitter.com/SaraMG)

Hosted by
* [Sammy Kaye Powers](https://twitter.com/SammyK)

# Background
Previous podcasts about PHP internals provide some context for this episode:
* [005: PHP Internals - Past, Present & Future](https://www.phproundtable.com/episode/php-internals-past-present-future)
* [025: PHP7 Release Management](https://www.phproundtable.com/episode/php7-release-management)
* [038: RFC Show & Tell](https://www.phproundtable.com/episode/proposed-features-of-php-71)
* [051: What happened to PHP 6?](https://www.phproundtable.com/episode/what-happened-to-php-6)
* [059: PHP 7.1](https://www.phproundtable.com/episode/php-7-1)

# Discussion - Sammy and Sara talk about...

## PHP 7.2 alpha 3
* Next release is beta 1
* Feature freeze/feature slushie is impending
* The [retry keyword](https://wiki.php.net/rfc/retry-keyword) will not be in PHP 7.2

## What is your setup when working on PHP internals?
* MacBook
* [VMware Fusion](https://my.vmware.com/en/web/vmware/info/slug/desktop_end_user_computing/vmware_fusion/8_0)
* [Ubuntu](https://www.ubuntu.com/)
* Bash and git aliases to [automate common tasks](https://xkcd.com/1205/)
* `make` tip: use [`-j N`](https://www.gnu.org/software/make/manual/html_node/Parallel.html) where N = [number of cores]+1

## Compiling PHP
* PHP is not difficult to compile but if you are using PHP in userland, use a pre-compiled binary from a package manager
* If you hit an issue with a pre-compiled binary, it cuts out a lot of ambiguity
* PHP does not distribute a `configure` script because it is generated from other files in the repository. Requiring users to generate it removes the possibility of `configure` being out of sync.

## The scanner and the parser
* PHP uses [re2c](http://re2c.org/) (regular expression to C) to generate a scanner (or lexer) and [Bison](https://www.gnu.org/software/bison/) to generate a parser
* The scanner splits the input PHP code into tokens
* The parser groups and arranges those tokens into meaningful expressions
* In PHP 5, the parser directly converted parsed expressions to [opcodes](http://php.net/manual/en/internals2.opcodes.php)
* In PHP 7, it is converted to an [Abstract Syntax Tree](https://wiki.php.net/rfc/abstract_syntax_tree) (AST)
* Using an AST allows the compiler to perform optimisations
* Sara's blog post about [the compiler processes](http://blog.golemon.com/2008/01/understanding-opcodes.html)
* Sara's blog post about [lexers and parsers](http://blog.golemon.com/2006/05/re2c-is-no-lemon.html)

## How does the executor (or VM) work?
* In PHP 4, this was basically a huge `while` loop with a `switch` statement in it:
  * Loop over each opline
  * `switch` statement defines behaviour for each opcode
* PHP 5 used a call VM:
  * We still loop over each opline
  * Instead of the big `switch`, each opline has a handler field containing a pointer to a callback function
* In PHP 7, the call VM is still in use but other styles are also used, including computed goto
* The [Zend VM](https://github.com/php/php-src/blob/master/Zend/zend_vm_def.h) is generated by a [PHP file](https://github.com/php/php-src/blob/master/Zend/zend_vm_gen.php). You can't build the PHP executor without PHP

## Testing
* PHP internals has ~15,000 tests
* Running the full test suite doesn't support parallelisation - they all run in series
* [PHP TestFest](https://phptestfest.org/) aims to encourage people to add tests to PHP Internals
* The test suite for PHP is written in PHP - you don't need to know C to contribute tests
* [PHP Code Coverage](http://gcov.php.net/) allows us to discover PHP internals code that is missing tests

## PHP Internals Documentation
* [PHP Internals Book](http://www.phpinternalsbook.com/)
* Internals lacks inline documentation in many places and the [Doxygen RFC](https://wiki.php.net/rfc/doxygen) recently failed
* [PHP 7 Virtual Machine](https://nikic.github.io/2017/04/14/PHP-7-Virtual-machine.html)
* ..and more generally [Nikita Popov's blog](https://nikic.github.io/)

## Sammy Kaye wraps up with
* Contribute [show notes](https://github.com/PHPRoundtable/show-notes/)
* Upcoming conferences:
  * [North East PHP](https://northeastphp2017.sched.com/)
  * [Zendcon](http://www.zendcon.com/)
  * [Pacific Northwest PHP](http://www.pnwphp.com/)
* Developer Shout-Out: Julien Pauli
* Shameless plugs:
  * [Donate](http://support.hopeforthewarriors.org/site/TR?fr_id=1180&pg=teamlist) to Team No Sleep 'till Brooklyn in [Rally North America](https://www.rallynorthamerica.com/)
